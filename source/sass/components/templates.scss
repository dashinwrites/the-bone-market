@import '../global/mixins.scss';

/*******************************
    Templates
********************************/

/* ================================
   LETTER
================================ */

.rp-letter {
  /* knobs (base defaults) */
  --paper: var(--bg-1);
  --ink:   var(--text-clear);
  --accent: var(--accent-2);
  --pad: 1.25rem;
  --radius: 12px;
  --maxw: 72ch;
  --rule: color-mix(in srgb, var(--ink) 45%, transparent);
  --title-script-scale: 1.15;                 /* 1.0–1.3 feels nice */
  --title-script-stroke: .35px;               /* add a hairline on light bgs */
  --title-script-stroke-color: rgba(0,0,0,.25);

  /* type tokens */
  --font-letter-serif: var(--font-serif, ui-serif);
  --font-letter-sans:  var(--font-sans, ui-sans-serif);
  /* default script stack (you can override per-letter via data-script) */
  --font-letter-script: "Lavishly Yours", "Cookie", "Lugrasimo", cursive;

  /* script tuning (per-letter overrideable) */
  --hand-weight: 400;
  --hand-size: 1.15rem;
  --hand-lh: 1.1;
  --hand-track: .005em;

  position: relative;
  display: grid;
  gap: .65rem;
  max-inline-size: var(--maxw);
  padding: var(--pad);
  border-radius: var(--radius);
  color: var(--ink);
  background: var(--paper);
  box-shadow:
    inset 0 0 0 1px color-mix(in srgb, var(--ink) 10%, transparent),
    0 10px 30px rgba(0,0,0,.18);
  isolation: isolate;

  /* Stationery options */
  &[data-stationery="parchment"] { --paper: #181716; }
  &[data-stationery="plain"]     { --paper: #121111; }

  /* Ink palettes (override theme tokens intentionally) */
  &[data-ink="black"] { --ink:#222; --rule:#2d2d2d; --accent:#6d5a4a; }
  &[data-ink="sepia"] { --ink:#2a2317; --accent:#9a7b54; }

  /* subtle texture + optional watermark */
  &::before {
    content:""; position:absolute; inset:0; border-radius:inherit; pointer-events:none;
    background:
      radial-gradient(120% 80% at 50% 10%, rgba(255,255,255,.06), #0000 60%),
      repeating-linear-gradient(0deg, #0000 0 30px, rgba(255,255,255,.02) 30px 31px);
    opacity:.35; mix-blend-mode:multiply;
  }
  &[data-watermark="crest"]::after{
    content:""; position:absolute; inset:10% 10% auto auto; pointer-events:none;
    inline-size: 180px; block-size: 180px; opacity:.08; filter: grayscale(1);
    background: var(--crest-url, none) center/contain no-repeat;
  }

  /* Header */
  .rp-head{ display:grid; grid-template-columns:auto 1fr auto; gap:.75rem; align-items:center; }
  .rp-crest{ inline-size:42px; block-size:42px; filter: drop-shadow(0 0 1px rgba(0,0,0,.3)); }
  .rp-from h1{ margin:0; font: 800 1.15rem/1 var(--font-letter-serif); letter-spacing:.01em; }
  .rp-from p{ margin:.15rem 0 0; color: color-mix(in srgb, var(--ink) 70%, transparent); }
  .rp-meta{ text-align:end; color: color-mix(in srgb, var(--ink) 70%, transparent); }

  /* Ink-ish rule */
  .rp-rule{
    border:0; height:2px; margin:.35rem 0 .5rem; border-radius:999px;
    background: linear-gradient(90deg, #0000 0%,
             color-mix(in srgb, var(--ink) 45%, transparent) 12% 88%, #0000 100%);
    opacity:.7;
  }

  .rp-address{ font-style: normal; line-height:1.5; }
  .rp-address--front{
    margin: 2.5rem 0 0; display:grid; gap:.25rem; place-items:center;
    text-align:center; font: 700 1.05rem/1.25 var(--font-letter-serif);
  }

  .rp-greeting, .rp-closing { margin:.35rem 0 0; }

  /* Body */
  .rp-body{ display:grid; gap:.6rem; line-height:1.7; font-family: var(--font-letter-serif); }

  /* Signature + script usage */
  .rp-signature{
    margin-top:.2rem; display:flex; align-items:center; gap:.75rem;
    .sig-name{
      font-family: var(--font-letter-script);
      font-weight: var(--hand-weight);
      font-size: clamp(1.05rem, 2.2vw, var(--hand-size));
      line-height: var(--hand-lh);
      letter-spacing: var(--hand-track);
    }
    .sig-mark{ inline-size:54px; block-size:28px; border-radius:999px;
      background: radial-gradient(closest-side at 40% 60%, var(--accent), #0000 70%);
      opacity:.35; filter: blur(.2px);
    }
    &[data-emboss] .sig-name{ text-shadow: 0 1px 0 rgba(0,0,0,.25); }
  }

  /* Script by default on greeting/closing too */
  .rp-greeting, .rp-closing { 
    font-family: var(--font-letter-script);
    font-weight: var(--hand-weight);
    letter-spacing: var(--hand-track);
    line-height: var(--hand-lh);
  }

  .rp-ps{ color: color-mix(in srgb, var(--ink) 78%, transparent); }
  .rp-enclosures{ margin-top:.35rem; padding-inline-start:1.2em;
    color: color-mix(in srgb, var(--ink) 70%, transparent);
    li+li{ margin-top:.2rem; }
  }

  /* Courier chip */
  .rp-courier{
    position:absolute; inset-block-start: .55rem; inset-inline-end: .55rem;
    font: 700 .7rem/1 var(--font-letter-sans); letter-spacing:.08em;
    padding:.25rem .45rem; border-radius:999px; text-transform:uppercase;
    background: color-mix(in srgb, var(--ink) 12%, transparent);
    box-shadow: inset 0 0 0 1px color-mix(in srgb, var(--ink) 35%, transparent);
  }

  /* Seals + placement */
  &[data-seal^="wax"]::marker, &[data-seal^="ribbon"]::marker, &[data-seal^="stamp"]::marker{ content:""; }
  &[data-seal^="wax"]::before,
  &[data-seal^="ribbon"]::before,
  &[data-seal^="stamp"]::before{
    content:""; position:absolute; inline-size:48px; block-size:48px; pointer-events:none;
    transform: translate(0,0); z-index:2; filter: drop-shadow(0 2px 6px rgba(0,0,0,.35));
  }
  &[data-seal^="wax"]::before{
    border-radius:50%;
    background:
      radial-gradient(closest-side, #b33 0 70%, #0000 71%),
      conic-gradient(from .25turn, #c44, #a22, #d55, #b33);
  }
  &[data-seal^="ribbon"]::before{
    inline-size:56px; block-size:56px; border-radius:10px;
    background:
      linear-gradient(#b64, #923),
      repeating-linear-gradient(90deg, #0000 0 6px, rgba(255,255,255,.15) 6px 8px);
    background-blend-mode:multiply;
    clip-path: polygon(0 0,100% 0,100% 70%,50% 100%,0 70%);
  }
  &[data-seal^="stamp"]::before{
    inline-size:44px; block-size:44px; border-radius:6px;
    background:
      radial-gradient(closest-side, #333 0 70%, #0000 71%),
      linear-gradient(135deg, #777, #444);
  }
  &[data-seal$="-tl"]::before{ inset: calc(var(--pad) - 6px) auto auto calc(var(--pad) - 6px); }
  &[data-seal$="-tr"]::before{ inset: calc(var(--pad) - 6px) calc(var(--pad) - 6px) auto auto; }
  &[data-seal$="-bl"]::before{ inset: auto auto calc(var(--pad) - 4px) calc(var(--pad) - 6px); }
  &[data-seal$="-br"]::before{ inset: auto calc(var(--pad) - 6px) calc(var(--pad) - 4px) auto; }

  /* Folds (default tuned for dark) */
  &[data-folds="1"]{ --folds: linear-gradient(#0000 48%, rgba(255,255,255,.06) 50%, #0000 52%) 0 15%/100% 100% no-repeat; }
  &[data-folds="2"]{ --folds:
      linear-gradient(#0000 48%, rgba(255,255,255,.06) 50%, #0000 52%) 0 38%/100% 100% no-repeat,
      linear-gradient(#0000 48%, rgba(255,255,255,.06) 50%, #0000 52%) 0 68%/100% 100% no-repeat; }
  &[data-folds="3"]{ --folds:
      linear-gradient(#0000 48%, rgba(255,255,255,.06) 50%, #0000 52%) 0 30%/100% 100% no-repeat,
      linear-gradient(#0000 48%, rgba(255,255,255,.06) 50%, #0000 52%) 0 55%/100% 100% no-repeat,
      linear-gradient(#0000 48%, rgba(255,255,255,.06) 50%, #0000 52%) 0 80%/100% 100% no-repeat; }
  &[data-folds]::before{ background: var(--folds),
                         radial-gradient(120% 80% at 50% 10%, rgba(255,255,255,.06), #0000 60%); }

  /* Quick house accents */
  .rp-head[data-house="black-salt"] ~ .rp-signature .sig-mark{ background: radial-gradient(closest-side at 40% 60%, #8d674d, #0000 70%); }
  .rp-head[data-house="glass-guild"] ~ .rp-signature .sig-mark{ background: radial-gradient(closest-side at 40% 60%, #7fb3d5, #0000 70%); }
}

/* ===========================
   SCRIPT SWITCHES (per-letter)
=========================== */
.rp-letter[data-script="lavishly"] { --font-letter-script: "Lavishly Yours", cursive; --hand-size: 1.2rem; --hand-lh: 1.05; --hand-track: .005em; }
.rp-letter[data-script="cookie"]   { --font-letter-script: "Cookie", cursive;          --hand-size: 1.15rem; --hand-lh: 1.1;  --hand-track: .01em; }
.rp-letter[data-script="lugrasimo"]{ --font-letter-script: "Lugrasimo", cursive;       --hand-size: 1.05rem; --hand-lh: 1.15; --hand-track: 0; }

/* Turn off script usage for greeting/closing/signature */
.rp-letter[data-hand="none"] .rp-greeting,
.rp-letter[data-hand="none"] .rp-closing,
.rp-letter[data-hand="none"] .rp-signature .sig-name { 
  font-family: var(--font-letter-serif);
  font-weight: 700;
  letter-spacing: .01em;
}

/* Utility: force script anywhere inside a letter */
.rp-letter .rp-script {
  font-family: var(--font-letter-script) !important;
  font-weight: var(--hand-weight);
  letter-spacing: var(--hand-track);
  line-height: var(--hand-lh);
}

/* SIZE VARIANTS */
.rp-letter[data-size="sm"]{ --pad:.9rem; --maxw:60ch; }
.rp-letter[data-size="lg"]{ --pad:1.5rem; --maxw:84ch; }

/* ===========================
   TITLE SCRIPT TOGGLE
   Use: <article class="rp-letter" data-script-title>
=========================== */
.rp-letter[data-script-title] .rp-from h1{
  font-family: var(--font-letter-script);
  font-weight: var(--hand-weight);
  letter-spacing: var(--hand-track);
  line-height: var(--hand-lh);
  /* scale & finesse knobs just for the title */
  font-size: clamp(1.1rem, 2.2vw, calc(var(--hand-size) * var(--title-script-scale, 1.15)));
  -webkit-text-stroke: var(--title-script-stroke, 0) var(--title-script-stroke-color, transparent);
}


/* Accessibility: forced-colors */
@media (forced-colors: active) {
  .rp-letter {
    background: Canvas; color: CanvasText;
    box-shadow: none; border: 1px solid CanvasText;
  }
  .rp-rule { background: CanvasText !important; opacity: .5; }
}


/* =========================================
   INHERIT FROM BODY[data-theme] IF PRESENT
   (applies only when the letter doesn’t set its own data-theme)
========================================= */
body[data-theme="light"] .rp-letter:not([data-theme]) {
  --paper:  #f7f4ee;
  --ink:    #2b2a28;
  --accent: #8b6a4a;
  --rule: color-mix(in srgb, var(--ink) 35%, transparent);

  color: var(--ink);
  background: var(--paper);
  box-shadow:
    inset 0 0 0 1px color-mix(in srgb, var(--ink) 10%, transparent),
    0 8px 22px rgba(0,0,0,.10);

  &::before{
    background:
      radial-gradient(120% 80% at 50% 10%, rgba(0,0,0,.06), #0000 60%),
      repeating-linear-gradient(0deg, #0000 0 30px, rgba(0,0,0,.025) 30px 31px);
    opacity:.35; mix-blend-mode:multiply;
  }

  /* light-leaning fold shading */
  &[data-folds="1"]{ --folds: linear-gradient(#0000 48%, rgba(0,0,0,.06) 50%, #0000 52%) 0 15%/100% 100% no-repeat; }
  &[data-folds="2"]{ --folds:
      linear-gradient(#0000 48%, rgba(0,0,0,.06) 50%, #0000 52%) 0 38%/100% 100% no-repeat,
      linear-gradient(#0000 48%, rgba(0,0,0,.06) 50%, #0000 52%) 0 68%/100% 100% no-repeat; }
  &[data-folds="3"]{ --folds:
      linear-gradient(#0000 48%, rgba(0,0,0,.06) 50%, #0000 52%) 0 30%/100% 100% no-repeat,
      linear-gradient(#0000 48%, rgba(0,0,0,.06) 50%, #0000 52%) 0 55%/100% 100% no-repeat,
      linear-gradient(#0000 48%, rgba(0,0,0,.06) 50%, #0000 52%) 0 80%/100% 100% no-repeat; }
}

body[data-theme="dark"] .rp-letter:not([data-theme]) {
  /* these match the base, included for clarity/priority */
  --paper:  #1c1b1a;
  --ink:    #ede7de;
  --accent: #b08b67;
  --rule: color-mix(in srgb, var(--ink) 45%, transparent);
  color: var(--ink); background: var(--paper);
  box-shadow:
    inset 0 0 0 1px color-mix(in srgb, var(--ink) 10%, transparent),
    0 10px 30px rgba(0,0,0,.18);
  &::before{
    background:
      radial-gradient(120% 80% at 50% 10%, rgba(255,255,255,.06), #0000 60%),
      repeating-linear-gradient(0deg, #0000 0 30px, rgba(255,255,255,.02) 30px 31px);
    opacity:.35; mix-blend-mode:multiply;
  }
}

/* =========================================
   PER-LETTER MANUAL OVERRIDES (always win)
========================================= */
.rp-letter[data-theme="light"] {
  --paper:#f7f4ee; --ink:#2b2a28; --accent:#8b6a4a;
  --rule: color-mix(in srgb, var(--ink) 35%, transparent);
  color: var(--ink); background: var(--paper);
  box-shadow:
    inset 0 0 0 1px color-mix(in srgb, var(--ink) 10%, transparent),
    0 8px 22px rgba(0,0,0,.10);
  &::before{
    background:
      radial-gradient(120% 80% at 50% 10%, rgba(0,0,0,.06), #0000 60%),
      repeating-linear-gradient(0deg, #0000 0 30px, rgba(0,0,0,.025) 30px 31px);
    opacity:.35; mix-blend-mode:multiply;
  }
}
.rp-letter[data-theme="dark"] {
  --paper:#1c1b1a; --ink:#ede7de; --accent:#b08b67;
  --rule: color-mix(in srgb, var(--ink) 45%, transparent);
  color: var(--ink); background: var(--paper);
  box-shadow:
    inset 0 0 0 1px color-mix(in srgb, var(--ink) 10%, transparent),
    0 10px 30px rgba(0,0,0,.18);
  &::before{
    background:
      radial-gradient(120% 80% at 50% 10%, rgba(255,255,255,.06), #0000 60%),
      repeating-linear-gradient(0deg, #0000 0 30px, rgba(255,255,255,.02) 30px 31px);
    opacity:.35; mix-blend-mode:multiply;
  }
}

/* ======================================
   SIZE VARIANTS (unchanged)
====================================== */
.rp-letter[data-size="sm"]{ --pad:.9rem; --maxw:60ch; }
.rp-letter[data-size="lg"]{ --pad:1.5rem; --maxw:84ch; }

/* Accessibility: forced-colors */
@media (forced-colors: active) {
  .rp-letter {
    background: Canvas; color: CanvasText;
    box-shadow: none; border: 1px solid CanvasText;
  }
  .rp-rule { background: CanvasText !important; opacity: .5; }
}