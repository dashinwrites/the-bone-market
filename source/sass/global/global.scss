@import '../global/mixins.scss';

/* ================================
   BASE / RESET
================================ */
html, body { margin: 0; padding: 0; }
body {
  background: var(--bg-1);
  color: var(--text-bg);
  font-size: var(--size-md);
  box-sizing: border-box;
}

/* Scrollbars */
*::-webkit-scrollbar { height: 6px; width: 6px; }
*::-webkit-scrollbar-track {
  border-radius: 1px; background-color: var(--bg-3);
  &:hover { background-color: var(--bg-2); }
  &:active { background-color: var(--bg-3); }
}
*::-webkit-scrollbar-thumb {
  border-radius: 2px; background-color: var(--accent-3);
  border: var(--bdash); border-color: var(--border-color);
  &:hover { background-color: var(--accent-2); }
  &:active { background-color: var(--accent-2); }
}

/* ================================
   LAYOUT
================================ */
.bg {
  position: fixed; inset: 0;
  inline-size: 100%; block-size: 100dvb;
  background: var(--bg-img) center/cover no-repeat fixed;
  opacity: .25;

  &::before {
    content: ""; position: fixed; inset: 0;
    background: var(--bg-texture) center/cover no-repeat fixed;
    background-blend-mode: var(--bg-blend);
    opacity: .3;
  }
}
.bm-container {
  position: relative;
  padding-block-start: var(--nav-h);
  padding-inline-start: var(--leftbar-w);
  min-block-size: 100dvb;
}
.bm-head { margin-block-start: calc(-1 * var(--frame-join)) !important; }
.bm-container > :first-child { margin-block-start: 0 !important; padding-block-start: 0 !important; }

/* ================================
   TYPOGRAPHY — HEADINGS (clean)
   - h7/h8 as real elements (block)
   - one underline system via data-uw
================================ */
h7, h8 { display: block; }

$heading-levels: (
  h2: (font: var(--font-title), weight: 800, size: clamp(1.4rem, 2.6vw, 1.9rem)),
  h3: (font: var(--font-serif), weight: 700, size: clamp(1.25rem, 2.2vw, 1.6rem)),
  h4: (font: var(--font-sans),  weight: 700, size: clamp(1.1rem, 1.8vw, 1.35rem)),
  h5: (font: var(--font-sans),  weight: 650, size: clamp(1rem, 1.6vw, 1.2rem),    track: .02em),
  h6: (font: var(--font-sans),  weight: 650, size: .98rem,                          track: .06em, upper: true),
  h7: (font: var(--font-sans),  weight: 600, size: .95rem,                          track: .08em, upper: true),
  h8: (font: var(--font-sans),  weight: 600, size: .90rem,                          track: .12em, upper: true)
);

@each $tag, $conf in $heading-levels {
  #{$tag} {
    font-family: map-get($conf, font);
    font-weight: map-get($conf, weight);
    font-size: map-get($conf, size);
    @if map-has-key($conf, track) { letter-spacing: map-get($conf, track); }
    @if map-has-key($conf, upper) and map-get($conf, upper) == true { text-transform: uppercase; }
  }
}

/* Base heading styles + underline driven by --uw */
h2, h3, h4, h5, h6, h7, h8 {
  /* default underline width is full heading width;
     override via data-uw="…" presets below */
  --uw: 100%;

  margin: .2rem 0 .6rem;
  line-height: 1.2;
  position: relative;
  isolation: isolate;        /* keeps caps above underline */
  padding-block-end: .3rem;
  color: var(--text-clear);

  &::after {
    content: "";
    position: absolute;
    bottom: 0;
    left: 0;                 /* start-aligned by default */
    width: var(--uw);
    height: 0;
    border-bottom: var(--bdash);
    border-bottom-color: currentColor;
    opacity: var(--h-underline-alpha, .30);
    pointer-events: none;
    z-index: 0;
  }

  /* Caps: left cap at start; right cap at end of visible line */
  &[data-caps] {
    &::before {
      content: "";
      position: absolute;
      bottom: 0; left: 0;
      width: 8px; height: 2px;
      background: currentColor; opacity: .35; z-index: 1;
    }
    > .hcap {
      position: absolute;
      bottom: 0;
      width: 8px; height: 2px;
      background: currentColor; opacity: .35; z-index: 1;
      left: var(--uw);
      transform: translateX(-100%);
    }
  }

  /* alignment tweaks */
  &[data-align="center"] {
    text-align: center;
    &::after { left: 50%; transform: translateX(-50%); width: var(--uw); }
    &[data-caps] {
      &::before { left: calc(50% - (var(--uw) / 2)); }
      > .hcap   { left: calc(50% + (var(--uw) / 2)); transform: translateX(-100%); }
    }
  }
  &[data-align="end"] {
    text-align: end;
    &::after { left: auto; right: 0; width: var(--uw); }
    &[data-caps] {
      &::before { left: auto; right: var(--uw); transform: none; }
      > .hcap   { left: auto; right: 0; transform: none; }
    }
  }

  /* opt-out */
  &[data-underline="none"]::after { content: none; }
}

/* font/weight helpers */
$tags: (h2, h3, h4, h5, h6, h7, h8);
$font-keys: (title, serif, sans, block, fancy, hand);
@each $t in $tags {
  @each $fk in $font-keys { #{$t}[data-font="#{$fk}"] { font-family: var(--font-#{$fk}); } }
  #{$t}[data-weight="regular"] { font-weight: 600; }
  #{$t}[data-weight="bold"]    { font-weight: 700; }
  #{$t}[data-weight="black"]   { font-weight: 800; }
}

/* ===== Underline width presets via data-uw =====
   Generates: [data-uw="60"] → --uw: 60% */
$uw-min: 10;  // lowest percent
$uw-max: 100; // highest percent
$uw-step: 2;  // step size
@for $p from $uw-min through $uw-max {
  @if ($p % $uw-step == 0) {
    h2[data-uw="#{$p}"],
    h3[data-uw="#{$p}"],
    h4[data-uw="#{$p}"],
    h5[data-uw="#{$p}"],
    h6[data-uw="#{$p}"],
    h7[data-uw="#{$p}"],
    h8[data-uw="#{$p}"] { --uw: #{$p}% }
  }
}

/* Convenience presets for “narrow/wide” if you still want them */
h2[data-underline="narrow"] { --uw: 28%; }
h3[data-underline="narrow"] { --uw: 26%; }
h4[data-underline="narrow"] { --uw: 24%; }
h5[data-underline="narrow"] { --uw: 22%; }
h6[data-underline="narrow"] { --uw: 20%; }
h7[data-underline="narrow"] { --uw: 18%; }
h8[data-underline="narrow"] { --uw: 16%; }

h2[data-underline="wide"]   { --uw: 60%; }
h3[data-underline="wide"]   { --uw: 54%; }
h4[data-underline="wide"]   { --uw: 48%; }
h5[data-underline="wide"]   { --uw: 42%; }
h6[data-underline="wide"]   { --uw: 36%; }
h7[data-underline="wide"]   { --uw: 32%; }
h8[data-underline="wide"]   { --uw: 30%; }

/* ================================
   INLINE TEXT + LINKS
================================ */
strong, b { font-weight: 700; color: var(--text-clear); }
em, i     { font-style: italic; }
u         { text-underline-offset: .14em; }
s, del    { opacity: .85; text-decoration-thickness: .08em; }

a {
  color: var(--link);
  text-decoration: underline;
  text-decoration-thickness: .06em;
  text-underline-offset: .18em;
  transition: color .15s ease;
  &:hover { color: var(--accent-1); }
  &:focus-visible { outline: none; box-shadow: inset 0 0 0 2px var(--accent-3); border-radius: 2px; }
}

/* ================================
   LISTS
================================ */
ul, ol { margin: 0 0 .9rem; padding-inline-start: 1.2em; }
li + li { margin-block-start: .35rem; }
li > ul, li > ol { margin-block-start: .35rem; }

/* Opt-in dashed list */
.dash-list {
  list-style: none; padding-inline-start: 1.2em;
  > li {
    position: relative;
    &::before {
      content: "—";
      position: absolute; inset-inline-start: -1.1em;
      color: var(--text-medCon);
    }
  }
}

/* ================================
   QUOTES (custom + blockquote plate)
================================ */
bm-quote,
.bm-quote {
  display: block;
  margin: .6rem 0;
  padding: .75rem 1rem;
  background: var(--bg-1-rgb);
  border-radius: 6px;
  box-shadow: inset 0 0 0 1px color-mix(in srgb, var(--text-loCon) 12%, transparent);
  position: relative;
}
bm-quote::before, .bm-quote::before {
  content: "❝";
  position: absolute;
  inset-inline-start: .55rem; inset-block-start: .35rem;
  font-size: 1.1rem; opacity: .35;
}
bm-quote :where(p, ul, ol):not(:last-child),
.bm-quote :where(p, ul, ol):not(:last-child) { margin-block-end: .5rem; }
bm-quote > cite, .bm-quote > cite {
  display: block; margin-block-start: .4rem; color: var(--text-medCon); font-style: normal;
}
bm-quote[data-tone="warn"], .bm-quote[data-tone="warn"] {
  box-shadow: inset 0 0 0 1px color-mix(in srgb, var(--warn) 35%, transparent);
  background: color-mix(in srgb, var(--warn) 10%, transparent);
}

/* plate-flavored blockquote */
blockquote {
  position: relative; display: block;
  margin: .8rem 0; padding: var(--bq-pad);
  max-width: 550px;
  background: var(--bg-1-rgb);
  border-radius: var(--bq-radius);
  border: var(--plate-border);
  box-shadow:
    inset 0 0 0 1px color-mix(in srgb, var(--text-loCon) 10%, transparent),
    0 10px 30px rgba(0,0,0,.08);
  text-align: justify; white-space: pre-line;

  > :where(p, ul, ol, pre, figure):not(:last-child) { margin-block-end: .55rem; }

  &::after {
    content: ""; position: absolute;
    inset-inline: 1rem 1rem; inset-block-start: .6rem;
    border-bottom: var(--bq-dash); opacity: .28; pointer-events: none;
  }
  &::before {
    content: ""; position: absolute; inset: 0; pointer-events: none;
    background:
      linear-gradient(currentColor, currentColor) top .5rem left .5rem / 14px 2px,
      linear-gradient(currentColor, currentColor) top .5rem left .5rem / 2px 14px,
      linear-gradient(currentColor, currentColor) bottom .5rem right .5rem / 14px 2px,
      linear-gradient(currentColor, currentColor) bottom .5rem right .5rem / 2px 14px;
    background-repeat: no-repeat; opacity: .18;
  }
  cite { display: block; margin-block-start: .45rem; color: var(--text-medCon); font-style: normal; font-size: .95em; }

  blockquote {
    margin: .6rem 0 0; transform: translateY(.1rem); opacity: .95;
    &::after { inset-inline: .8rem .8rem; inset-block-start: .55rem; opacity: .24; }
  }

  &[data-tone="warn"] {
    --bq-accent: var(--warn);
    box-shadow:
      inset 0 0 0 1px color-mix(in srgb, var(--warn) 22%, transparent),
      0 10px 30px rgba(0,0,0,.08);
  }
  &[data-tone="accent"] {
    --bq-accent: var(--accent-2);
    box-shadow:
      inset 0 0 0 1px color-mix(in srgb, var(--accent-2) 22%, transparent),
      0 10px 30px rgba(0,0,0,.08);
  }
}
blockquote[data-rule] {
  padding-inline-start: calc(1rem + 6px);
  border-inline-start: 4px solid color-mix(in srgb, var(--bq-accent) 65%, transparent);
}

/* ================================
   SPOILERS
================================ */
details.spoiler {
  border: 1px dashed color-mix(in srgb, var(--text-loCon) 35%, transparent);
  border-radius: 6px; padding: .5rem .75rem;

  summary {
    cursor: pointer; color: var(--text-medCon); list-style: none;
    &::-webkit-details-marker { display: none; }
    &:hover { color: var(--text-clear); }
  }
  &[open] { border-style: solid; }
  > *:not(summary) { margin-block-start: .5rem; }
}
.spoiler-inline {
  background: color-mix(in srgb, var(--bg-3) 60%, transparent);
  color: transparent; text-shadow: 0 0 12px rgba(0,0,0,.55);
  border-radius: 3px; padding: 0 .2em; transition: color .15s;
  &.is-open { color: inherit; text-shadow: none; }
}

/* ================================
   I18N HELPERS
================================ */
ruby rt { font-size: .75em; color: var(--text-medCon); letter-spacing: .02em; }
.tr {
  position: relative; border-bottom: 1px dotted var(--text-loCon); cursor: help;
  &:hover::after {
    content: attr(data-tr); position: absolute; inset-inline-start: 0; inset-block-end: 100%;
    transform: translateY(-4px);
    background: var(--bg-2); color: var(--text-clear);
    padding: .25rem .4rem; border-radius: 4px;
    border: 1px solid color-mix(in srgb, var(--text-loCon) 20%, transparent);
    box-shadow: 0 6px 20px rgba(0,0,0,.18); white-space: nowrap; z-index: 10;
  }
}

/* ================================
   CALLOUTS
================================ */
.tw, .note {
  padding: .65rem .8rem .7rem;
  border-radius: 6px; border: 1px solid; display: grid; gap: .35rem;
}
.tw {
  border-color: color-mix(in srgb, var(--warn) 45%, transparent);
  background: color-mix(in srgb, var(--warn) 10%, transparent);
  color: color-mix(in srgb, var(--warn) 85%, var(--text-clear));
}
.note {
  border-color: color-mix(in srgb, var(--accent-2) 40%, transparent);
  background: color-mix(in srgb, var(--accent-2) 10%, transparent);
  color: var(--text-clear);
}
.tw > strong, .note > strong {
  text-transform: lowercase; letter-spacing: .06em; font: 700 .9rem/1 var(--font-sans);
}

/* ================================
   RULES & UTILITIES
================================ */
hr {
  border: 0;
  margin-block: .9rem;
  background: none;
  position: relative;
  block-size: 1px;           /* was 0 — needs paint area */
  overflow: visible;         /* be safe if the line sits at the edge */

  &::before {
    content: "";
    display: block;
    inline-size: var(--hr-w, 40%);
    margin-inline: auto;
    border-bottom: var(--bdash);
    border-bottom-color: color-mix(in srgb, var(--text-loCon) 35%, transparent);
    opacity: .35;
  }
}
vr {
  inline-size: 1px; block-size: 1.25em; background: color-mix(in srgb, var(--text-loCon) 20%, transparent);
  display: inline-block; vertical-align: middle; margin-inline: .5rem;
}
.content-flow { max-inline-size: var(--content-max); margin: 0 auto; }

/* ================================
   GROUP HEAD
================================ */
.group-head {
  /* knobs */
  --gh-thickness: 2px;
  --gh-alpha: .35;
  --gh-grad: linear-gradient(90deg,
    color-mix(in srgb, var(--text-loCon) 0%,  transparent) 0%,
    color-mix(in srgb, var(--text-loCon) 55%, transparent) 12%,
    color-mix(in srgb, var(--text-loCon) 55%, transparent) 88%,
    color-mix(in srgb, var(--text-loCon) 0%,  transparent) 100%
  );

  position: relative;
  display: grid;
  grid-template-columns: auto minmax(0,1fr);
  align-items: end;
  column-gap: var(--gh-gap-x);
  row-gap: var(--gh-gap-y);
  padding-block-end: var(--gh-pad-b);
  color: var(--text-clear);

  /* gradient rule (default) */
  &::after{
    content:"";
    position:absolute;
    inset-inline: 0;
    inset-block-end: 0;
    height: var(--gh-thickness);
    background: var(--gh-grad);
    opacity: var(--gh-alpha);
    pointer-events: none;
    border: 0;
  }

  /* line style variants (non-gradient) */
  &[data-line="solid"]::after {
    background: none;
    height: 0;
    border-bottom: 1px solid color-mix(in srgb, var(--text-loCon) 35%, transparent);
  }
  &[data-line="dash"]::after {
    background: none;
    height: 0;
    border-bottom: var(--bdash);
  }
  &[data-line="none"]::after { content: none; }

  /* gradient presets */
  &[data-gradient="accent"] {
    --gh-grad: linear-gradient(90deg,
      color-mix(in srgb, var(--accent-1) 0%,  transparent) 0%,
      color-mix(in srgb, var(--accent-1) 70%, transparent) 50%,
      color-mix(in srgb, var(--accent-1) 0%,  transparent) 100%
    );
  }
  &[data-gradient="duo"] {
    --gh-grad: linear-gradient(90deg,
      color-mix(in srgb, var(--accent-1) 70%, transparent) 0% 50%,
      color-mix(in srgb, var(--accent-2) 70%, transparent) 50% 100%
    );
  }
}

.group-head__title{
  font-family: var(--font-serif);
  font-weight: 800;
  font-size: clamp(1.25rem, 2.2vw, 1.75rem);
  line-height: 1.05;
  white-space: nowrap;
}
.group-head__desc{
  justify-self: end;
  text-align: end;
  font: 600 .95rem/1.2 var(--font-serif);
  color: var(--text-medCon);
  max-inline-size: var(--gh-max-desc);
}

/* ================================
   LETTER
================================ */

.rp-letter {
  /* knobs (base defaults) */
  --paper: var(--bg-1);
  --ink:   var(--text-clear);
  --accent: var(--accent-2);
  --pad: 1.25rem;
  --radius: 12px;
  --maxw: 72ch;
  --rule: color-mix(in srgb, var(--ink) 45%, transparent);
  --title-script-scale: 1.15;                 /* 1.0–1.3 feels nice */
  --title-script-stroke: .35px;               /* add a hairline on light bgs */
  --title-script-stroke-color: rgba(0,0,0,.25);

  /* type tokens */
  --font-letter-serif: var(--font-serif, ui-serif);
  --font-letter-sans:  var(--font-sans, ui-sans-serif);
  /* default script stack (you can override per-letter via data-script) */
  --font-letter-script: "Lavishly Yours", "Cookie", "Lugrasimo", cursive;

  /* script tuning (per-letter overrideable) */
  --hand-weight: 400;
  --hand-size: 1.15rem;
  --hand-lh: 1.1;
  --hand-track: .005em;

  position: relative;
  display: grid;
  gap: .65rem;
  max-inline-size: var(--maxw);
  padding: var(--pad);
  border-radius: var(--radius);
  color: var(--ink);
  background: var(--paper);
  box-shadow:
    inset 0 0 0 1px color-mix(in srgb, var(--ink) 10%, transparent),
    0 10px 30px rgba(0,0,0,.18);
  isolation: isolate;

  /* Stationery options */
  &[data-stationery="parchment"] { --paper: #181716; }
  &[data-stationery="plain"]     { --paper: #121111; }

  /* Ink palettes (override theme tokens intentionally) */
  &[data-ink="black"] { --ink:#222; --rule:#2d2d2d; --accent:#6d5a4a; }
  &[data-ink="sepia"] { --ink:#2a2317; --accent:#9a7b54; }

  /* subtle texture + optional watermark */
  &::before {
    content:""; position:absolute; inset:0; border-radius:inherit; pointer-events:none;
    background:
      radial-gradient(120% 80% at 50% 10%, rgba(255,255,255,.06), #0000 60%),
      repeating-linear-gradient(0deg, #0000 0 30px, rgba(255,255,255,.02) 30px 31px);
    opacity:.35; mix-blend-mode:multiply;
  }
  &[data-watermark="crest"]::after{
    content:""; position:absolute; inset:10% 10% auto auto; pointer-events:none;
    inline-size: 180px; block-size: 180px; opacity:.08; filter: grayscale(1);
    background: var(--crest-url, none) center/contain no-repeat;
  }

  /* Header */
  .rp-head{ display:grid; grid-template-columns:auto 1fr auto; gap:.75rem; align-items:center; }
  .rp-crest{ inline-size:42px; block-size:42px; filter: drop-shadow(0 0 1px rgba(0,0,0,.3)); }
  .rp-from h1{ margin:0; font: 800 1.15rem/1 var(--font-letter-serif); letter-spacing:.01em; }
  .rp-from p{ margin:.15rem 0 0; color: color-mix(in srgb, var(--ink) 70%, transparent); }
  .rp-meta{ text-align:end; color: color-mix(in srgb, var(--ink) 70%, transparent); }

  /* Ink-ish rule */
  .rp-rule{
    border:0; height:2px; margin:.35rem 0 .5rem; border-radius:999px;
    background: linear-gradient(90deg, #0000 0%,
             color-mix(in srgb, var(--ink) 45%, transparent) 12% 88%, #0000 100%);
    opacity:.7;
  }

  .rp-address{ font-style: normal; line-height:1.5; }
  .rp-address--front{
    margin: 2.5rem 0 0; display:grid; gap:.25rem; place-items:center;
    text-align:center; font: 700 1.05rem/1.25 var(--font-letter-serif);
  }

  .rp-greeting, .rp-closing { margin:.35rem 0 0; }

  /* Body */
  .rp-body{ display:grid; gap:.6rem; line-height:1.7; font-family: var(--font-letter-serif); }

  /* Signature + script usage */
  .rp-signature{
    margin-top:.2rem; display:flex; align-items:center; gap:.75rem;
    .sig-name{
      font-family: var(--font-letter-script);
      font-weight: var(--hand-weight);
      font-size: clamp(1.05rem, 2.2vw, var(--hand-size));
      line-height: var(--hand-lh);
      letter-spacing: var(--hand-track);
    }
    .sig-mark{ inline-size:54px; block-size:28px; border-radius:999px;
      background: radial-gradient(closest-side at 40% 60%, var(--accent), #0000 70%);
      opacity:.35; filter: blur(.2px);
    }
    &[data-emboss] .sig-name{ text-shadow: 0 1px 0 rgba(0,0,0,.25); }
  }

  /* Script by default on greeting/closing too */
  .rp-greeting, .rp-closing { 
    font-family: var(--font-letter-script);
    font-weight: var(--hand-weight);
    letter-spacing: var(--hand-track);
    line-height: var(--hand-lh);
  }

  .rp-ps{ color: color-mix(in srgb, var(--ink) 78%, transparent); }
  .rp-enclosures{ margin-top:.35rem; padding-inline-start:1.2em;
    color: color-mix(in srgb, var(--ink) 70%, transparent);
    li+li{ margin-top:.2rem; }
  }

  /* Courier chip */
  .rp-courier{
    position:absolute; inset-block-start: .55rem; inset-inline-end: .55rem;
    font: 700 .7rem/1 var(--font-letter-sans); letter-spacing:.08em;
    padding:.25rem .45rem; border-radius:999px; text-transform:uppercase;
    background: color-mix(in srgb, var(--ink) 12%, transparent);
    box-shadow: inset 0 0 0 1px color-mix(in srgb, var(--ink) 35%, transparent);
  }

  /* Seals + placement */
  &[data-seal^="wax"]::marker, &[data-seal^="ribbon"]::marker, &[data-seal^="stamp"]::marker{ content:""; }
  &[data-seal^="wax"]::before,
  &[data-seal^="ribbon"]::before,
  &[data-seal^="stamp"]::before{
    content:""; position:absolute; inline-size:48px; block-size:48px; pointer-events:none;
    transform: translate(0,0); z-index:2; filter: drop-shadow(0 2px 6px rgba(0,0,0,.35));
  }
  &[data-seal^="wax"]::before{
    border-radius:50%;
    background:
      radial-gradient(closest-side, #b33 0 70%, #0000 71%),
      conic-gradient(from .25turn, #c44, #a22, #d55, #b33);
  }
  &[data-seal^="ribbon"]::before{
    inline-size:56px; block-size:56px; border-radius:10px;
    background:
      linear-gradient(#b64, #923),
      repeating-linear-gradient(90deg, #0000 0 6px, rgba(255,255,255,.15) 6px 8px);
    background-blend-mode:multiply;
    clip-path: polygon(0 0,100% 0,100% 70%,50% 100%,0 70%);
  }
  &[data-seal^="stamp"]::before{
    inline-size:44px; block-size:44px; border-radius:6px;
    background:
      radial-gradient(closest-side, #333 0 70%, #0000 71%),
      linear-gradient(135deg, #777, #444);
  }
  &[data-seal$="-tl"]::before{ inset: calc(var(--pad) - 6px) auto auto calc(var(--pad) - 6px); }
  &[data-seal$="-tr"]::before{ inset: calc(var(--pad) - 6px) calc(var(--pad) - 6px) auto auto; }
  &[data-seal$="-bl"]::before{ inset: auto auto calc(var(--pad) - 4px) calc(var(--pad) - 6px); }
  &[data-seal$="-br"]::before{ inset: auto calc(var(--pad) - 6px) calc(var(--pad) - 4px) auto; }

  /* Folds (default tuned for dark) */
  &[data-folds="1"]{ --folds: linear-gradient(#0000 48%, rgba(255,255,255,.06) 50%, #0000 52%) 0 15%/100% 100% no-repeat; }
  &[data-folds="2"]{ --folds:
      linear-gradient(#0000 48%, rgba(255,255,255,.06) 50%, #0000 52%) 0 38%/100% 100% no-repeat,
      linear-gradient(#0000 48%, rgba(255,255,255,.06) 50%, #0000 52%) 0 68%/100% 100% no-repeat; }
  &[data-folds="3"]{ --folds:
      linear-gradient(#0000 48%, rgba(255,255,255,.06) 50%, #0000 52%) 0 30%/100% 100% no-repeat,
      linear-gradient(#0000 48%, rgba(255,255,255,.06) 50%, #0000 52%) 0 55%/100% 100% no-repeat,
      linear-gradient(#0000 48%, rgba(255,255,255,.06) 50%, #0000 52%) 0 80%/100% 100% no-repeat; }
  &[data-folds]::before{ background: var(--folds),
                         radial-gradient(120% 80% at 50% 10%, rgba(255,255,255,.06), #0000 60%); }

  /* Quick house accents */
  .rp-head[data-house="black-salt"] ~ .rp-signature .sig-mark{ background: radial-gradient(closest-side at 40% 60%, #8d674d, #0000 70%); }
  .rp-head[data-house="glass-guild"] ~ .rp-signature .sig-mark{ background: radial-gradient(closest-side at 40% 60%, #7fb3d5, #0000 70%); }
}

/* ===========================
   SCRIPT SWITCHES (per-letter)
=========================== */
.rp-letter[data-script="lavishly"] { --font-letter-script: "Lavishly Yours", cursive; --hand-size: 1.2rem; --hand-lh: 1.05; --hand-track: .005em; }
.rp-letter[data-script="cookie"]   { --font-letter-script: "Cookie", cursive;          --hand-size: 1.15rem; --hand-lh: 1.1;  --hand-track: .01em; }
.rp-letter[data-script="lugrasimo"]{ --font-letter-script: "Lugrasimo", cursive;       --hand-size: 1.05rem; --hand-lh: 1.15; --hand-track: 0; }

/* Turn off script usage for greeting/closing/signature */
.rp-letter[data-hand="none"] .rp-greeting,
.rp-letter[data-hand="none"] .rp-closing,
.rp-letter[data-hand="none"] .rp-signature .sig-name { 
  font-family: var(--font-letter-serif);
  font-weight: 700;
  letter-spacing: .01em;
}

/* Utility: force script anywhere inside a letter */
.rp-letter .rp-script {
  font-family: var(--font-letter-script) !important;
  font-weight: var(--hand-weight);
  letter-spacing: var(--hand-track);
  line-height: var(--hand-lh);
}

/* SIZE VARIANTS */
.rp-letter[data-size="sm"]{ --pad:.9rem; --maxw:60ch; }
.rp-letter[data-size="lg"]{ --pad:1.5rem; --maxw:84ch; }

/* ===========================
   TITLE SCRIPT TOGGLE
   Use: <article class="rp-letter" data-script-title>
=========================== */
.rp-letter[data-script-title] .rp-from h1{
  font-family: var(--font-letter-script);
  font-weight: var(--hand-weight);
  letter-spacing: var(--hand-track);
  line-height: var(--hand-lh);
  /* scale & finesse knobs just for the title */
  font-size: clamp(1.1rem, 2.2vw, calc(var(--hand-size) * var(--title-script-scale, 1.15)));
  -webkit-text-stroke: var(--title-script-stroke, 0) var(--title-script-stroke-color, transparent);
}


/* Accessibility: forced-colors */
@media (forced-colors: active) {
  .rp-letter {
    background: Canvas; color: CanvasText;
    box-shadow: none; border: 1px solid CanvasText;
  }
  .rp-rule { background: CanvasText !important; opacity: .5; }
}


/* =========================================
   INHERIT FROM BODY[data-theme] IF PRESENT
   (applies only when the letter doesn’t set its own data-theme)
========================================= */
body[data-theme="light"] .rp-letter:not([data-theme]) {
  --paper:  #f7f4ee;
  --ink:    #2b2a28;
  --accent: #8b6a4a;
  --rule: color-mix(in srgb, var(--ink) 35%, transparent);

  color: var(--ink);
  background: var(--paper);
  box-shadow:
    inset 0 0 0 1px color-mix(in srgb, var(--ink) 10%, transparent),
    0 8px 22px rgba(0,0,0,.10);

  &::before{
    background:
      radial-gradient(120% 80% at 50% 10%, rgba(0,0,0,.06), #0000 60%),
      repeating-linear-gradient(0deg, #0000 0 30px, rgba(0,0,0,.025) 30px 31px);
    opacity:.35; mix-blend-mode:multiply;
  }

  /* light-leaning fold shading */
  &[data-folds="1"]{ --folds: linear-gradient(#0000 48%, rgba(0,0,0,.06) 50%, #0000 52%) 0 15%/100% 100% no-repeat; }
  &[data-folds="2"]{ --folds:
      linear-gradient(#0000 48%, rgba(0,0,0,.06) 50%, #0000 52%) 0 38%/100% 100% no-repeat,
      linear-gradient(#0000 48%, rgba(0,0,0,.06) 50%, #0000 52%) 0 68%/100% 100% no-repeat; }
  &[data-folds="3"]{ --folds:
      linear-gradient(#0000 48%, rgba(0,0,0,.06) 50%, #0000 52%) 0 30%/100% 100% no-repeat,
      linear-gradient(#0000 48%, rgba(0,0,0,.06) 50%, #0000 52%) 0 55%/100% 100% no-repeat,
      linear-gradient(#0000 48%, rgba(0,0,0,.06) 50%, #0000 52%) 0 80%/100% 100% no-repeat; }
}

body[data-theme="dark"] .rp-letter:not([data-theme]) {
  /* these match the base, included for clarity/priority */
  --paper:  #1c1b1a;
  --ink:    #ede7de;
  --accent: #b08b67;
  --rule: color-mix(in srgb, var(--ink) 45%, transparent);
  color: var(--ink); background: var(--paper);
  box-shadow:
    inset 0 0 0 1px color-mix(in srgb, var(--ink) 10%, transparent),
    0 10px 30px rgba(0,0,0,.18);
  &::before{
    background:
      radial-gradient(120% 80% at 50% 10%, rgba(255,255,255,.06), #0000 60%),
      repeating-linear-gradient(0deg, #0000 0 30px, rgba(255,255,255,.02) 30px 31px);
    opacity:.35; mix-blend-mode:multiply;
  }
}

/* =========================================
   PER-LETTER MANUAL OVERRIDES (always win)
========================================= */
.rp-letter[data-theme="light"] {
  --paper:#f7f4ee; --ink:#2b2a28; --accent:#8b6a4a;
  --rule: color-mix(in srgb, var(--ink) 35%, transparent);
  color: var(--ink); background: var(--paper);
  box-shadow:
    inset 0 0 0 1px color-mix(in srgb, var(--ink) 10%, transparent),
    0 8px 22px rgba(0,0,0,.10);
  &::before{
    background:
      radial-gradient(120% 80% at 50% 10%, rgba(0,0,0,.06), #0000 60%),
      repeating-linear-gradient(0deg, #0000 0 30px, rgba(0,0,0,.025) 30px 31px);
    opacity:.35; mix-blend-mode:multiply;
  }
}
.rp-letter[data-theme="dark"] {
  --paper:#1c1b1a; --ink:#ede7de; --accent:#b08b67;
  --rule: color-mix(in srgb, var(--ink) 45%, transparent);
  color: var(--ink); background: var(--paper);
  box-shadow:
    inset 0 0 0 1px color-mix(in srgb, var(--ink) 10%, transparent),
    0 10px 30px rgba(0,0,0,.18);
  &::before{
    background:
      radial-gradient(120% 80% at 50% 10%, rgba(255,255,255,.06), #0000 60%),
      repeating-linear-gradient(0deg, #0000 0 30px, rgba(255,255,255,.02) 30px 31px);
    opacity:.35; mix-blend-mode:multiply;
  }
}

/* ======================================
   SIZE VARIANTS (unchanged)
====================================== */
.rp-letter[data-size="sm"]{ --pad:.9rem; --maxw:60ch; }
.rp-letter[data-size="lg"]{ --pad:1.5rem; --maxw:84ch; }

/* Accessibility: forced-colors */
@media (forced-colors: active) {
  .rp-letter {
    background: Canvas; color: CanvasText;
    box-shadow: none; border: 1px solid CanvasText;
  }
  .rp-rule { background: CanvasText !important; opacity: .5; }
}


/* ================================
   MEDIA QUERIES
================================ */
@media (max-width: 720px) {
  blockquote::after { inset-inline: .75rem .75rem; inset-block-start: .55rem; }
}

/* Small screens: stack title above description */
@media (max-width: 680px){
  .group-head{ grid-template-columns: 1fr; align-items: start; }
  .group-head__title{ white-space: normal; }
  .group-head__desc{ justify-self: start; text-align: start; max-inline-size: none; }
}

/* ================================
   DEBUG HELPERS
================================ */
html.debug * { outline: 1px dotted rgba(255, 0, 200, .35); }
html.debug #navstrip { outline: 2px solid lime; }
html.debug #leftbar  { outline: 2px solid cyan; }
html.debug .bm-container { outline: 2px solid orange; }
html.debug .bm-head { outline: 2px solid red; }
