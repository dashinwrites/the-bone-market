@import "../global/mixins.scss";

/*******************************
   Board Stats
********************************/

/* --------------------------------
   Global DX tokens for this module
--------------------------------- */
:root {
  --stats-pad-inset: 0.5rem;
  --stats-gap: 1rem;
}

/* --------------------------------
   Reusable helpers (mixins)
--------------------------------- */
@mixin inset-dash($inset: 0.5rem) {
  content: "";
  position: absolute;
  inset: $inset;
  border: var(--bdash);
  border-radius: 4px;
  opacity: 0.25;
  pointer-events: none;
}

@mixin scroll-pane {
  max-block-size: var(--stats-pane-h);
  overflow: auto;
  overscroll-behavior: contain;
  -webkit-overflow-scrolling: touch;
}

/* ---------------- Container ---------------- */
#boardstats.bm-stats {
  margin: 2rem auto;
  padding: 1rem 1rem 1.25rem;
  max-inline-size: clamp(820px, 80vw, 1280px);
  position: relative;
  color: var(--text-clear);
  background: var(--bg-1-rgb);
  border: var(--border-1);
  border-radius: 8px;
  box-shadow: var(--plate-shadow);

  &::before {
    content: "";
    position: absolute;
    inset: 0.6rem;
    opacity: 0.35;
    pointer-events: none;
  }
  @include corner-ticks(.6rem, 18px, 2px, .25);
}

/* ---------------- Header ---------------- */
.bm-stats__header {
  display: grid;
  grid-template-columns: 1fr auto;
  align-items: end;
  gap: 1rem;
  margin-block-end: 1rem;

  @media (max-width: 720px) {
    grid-template-columns: 1fr;
    align-items: start;
    gap: 0.5rem;
  }
}

.bm-stats__title {
  margin: 0;
  font-family: var(--font-serif);
  letter-spacing: 0.12em;
  text-transform: lowercase;
}

/* quick totals */
.bm-stats__totals {
  --pad: 0.4rem 0.6rem;
  display: grid;
  grid-auto-flow: column;
  gap: 0.5rem;
  list-style: none;
  margin: 0;
  padding: 0;

  li {
    display: grid;
    grid-template-rows: auto auto;
    justify-items: center;
    min-inline-size: 8ch; /* was 9ch */
    padding: var(--pad);
    position: relative;
    background: var(--bg-2);
    border: var(--border-1);
    border-radius: 6px;

    &::after { @include inset-dash(0.35rem); }

    span {
      font-size: 0.8rem;
      color: var(--text-loCon);
      text-transform: lowercase;
    }
    b {
      font-size: 1.1rem;
      font-weight: 700;
      /* tabular if font supports it */
      font-feature-settings: "tnum" 1, "ss01" 1;
    }
  }

  @media (max-width: 900px) {
    grid-auto-flow: row;
    grid-template-columns: repeat(2, minmax(0, 1fr));
  }
}

/* ---------------- Grid layout ---------------- */
.bm-stats__grid {
  display: grid;
  gap: var(--stats-gap);
  grid-template-columns: repeat(12, 1fr);

  .bm-card--today,
  .bm-card--now { grid-column: span 6; }

  .bm-card--legend { grid-column: span 4; }
  .bm-card--recent { grid-column: span 8; }

  @media (max-width: 1080px) {
    .bm-card--today,
    .bm-card--now,
    .bm-card--legend,
    .bm-card--recent {
      grid-column: 1 / -1;
    }
  }
}

/* ---------------- Card ---------------- */
.bm-card {
  position: relative;
  padding: 1rem;
  background: var(--bg-2);
  border: var(--border-1);
  border-radius: 6px;
}

.bm-card__title {
  margin: 0 0 0.5rem;
  font-family: var(--font-serif);
  font-size: var(--size-lg, 1.1rem);
}

.bm-card__meta,
.bm-card__hint {
  margin: 0 0 0.5rem;
  color: var(--text-loCon);
}

.bm-card__list { line-height: 1.6; }

.bm-card__list--wrap {
  display: flex;
  flex-wrap: wrap;
  gap: 0.4rem 0.75rem;
}

/* Toolbar */
.bm-toolbar {
  display: flex;
  flex-wrap: wrap;
  gap: 0.6rem 0.9rem;
  margin-block: 0.25rem 0.75rem;

  a {
    font-size: 0.95rem;
    text-decoration: underline;
  }
}

/* ---------------- Legend ---------------- */
.bm-legend {
  display: grid;
  gap: 0.4rem;
  list-style: none;
  margin: 0;
  padding: 0;

  li {
    display: grid;
    grid-auto-flow: column;
    align-items: center;
    justify-content: start;
    gap: 0.6rem;
  }
}

.chip {
  inline-size: 14px;
  block-size: 14px;
  display: inline-block;
  border-radius: 50%;
  border: 2px solid rgba(0, 0, 0, 0.25); /* fallback */

  @supports (color: color-mix(in oklab, black, white)) {
    border-color: color-mix(in oklab, currentColor 25%, transparent);
  }
}

/* Example colors; replace with your tokens */
.chip--celestial { background: var(--celestial, rgb(160, 180, 255)); }
.chip--flora     { background: var(--flora,     rgb(170, 215, 170)); }
.chip--anatomy   { background: var(--anatomy,   rgb(240, 180, 180)); }
.chip--material  { background: var(--material,  rgb(210, 190, 160)); }

/* ---------------- Recent Topics (table â†’ list look) ---------------- */
.bm-card--recent {
  @include scroll-pane;
  padding: 0.25rem;

  #recent-topics {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 1rem;

    @media (max-width: 880px) {
      grid-template-columns: 1fr; /* stack on smaller screens */
    }

    .maintitle, hr, table > tbody > tr:first-child { display: none !important; }
  }

  table,
  tbody {
    display: contents;
  }

  /* each topic card */
  tr {
    display: grid;
    grid-template-rows: auto auto auto;
    align-items: start;
    gap: 0.05rem;
    padding: 1rem;
    position: relative;
    background: var(--bg-2);
    box-shadow: var(--plate-shadow);
  }

  /* reset jcink legacy */
  .row4,
  .recent-topics-info,
  .recent-topics-date {
    background: none;
    border: 0;
    padding: 0;
    width: auto;
  }

  /* Title */
  .recent-topics-info > a:first-child strong {
    display: inline-block;
    font-weight: 700;
    text-underline-offset: 0.12em;
    max-inline-size: 100%;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
  }

  /* Author line */
  .recent-topics-info > .rt-author {
    display: flex;
    align-items: baseline;
    gap: 0.5rem;
    color: var(--text-loCon);
    font-family: var(--font-sans);
    font-size: var(--size-md);
    text-transform: lowercase;

    &::before {
      content: "fig. 01";
      white-space: nowrap;
      font-variant: all-small-caps;
      font-family: var(--font-hand);
      opacity: 0.9;
    }

    a {
      white-space: nowrap;
      color: var(--text-clear);
    }
  }

  /* Date line */
  .recent-topics-date {
    display: grid;
    grid-template-columns: clamp(4px, 12vw, 36px) 1fr;
    align-items: center;
    column-gap: 0.75rem;
    color: var(--text-loCon);
    font-size: var(--size-lg);
    font-family: var(--font-sans);
    font-variant: all-small-caps;
    justify-self: start;
    letter-spacing: 0.05rem;

    &::before {
      content: "";
      inline-size: 100%;
      block-size: 1px;
      background: var(--accent-1);
      opacity: 0.8;
      display: block;
    }
  }

  /* remove jcink empty link */
  .recent-topics-info > a:empty {
    display: none;
  }

  /* links */
  :where(a) {
    text-underline-offset: 0.15em;
  }

  /* Mobile wrap for author line */
  @media (max-width: 420px) {
    .recent-topics-info > .rt-author {
      flex-wrap: wrap;
      row-gap: 0.25rem;
    }
  }
}

/* title link (consolidated once) */
.rt-title {
  display: inline-block;
  max-inline-size: 100%;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
  text-transform: lowercase;
  font-family: var(--font-serif);
  font-size: calc(var(--size-forum-title) - 4px);
  transition: var(--transi-med);
  position: relative; /* for underline animation */

  &:hover { letter-spacing: 0.05rem; }

  &::after {
    content: "";
    position: absolute;
    left: 0;
    bottom: 0;
    inline-size: 100%;
    block-size: 1px;
    background: var(--accent-1);
    transform: scaleX(0);
    transform-origin: bottom right;
    transition: transform 0.25s ease-in-out;
  }

  &:hover::after,
  &:focus-visible::after {
    transform: scaleX(1);
    transform-origin: bottom left;
  }
}

/* ---------------- Scroll panes (shared) ---------------- */
.bm-card--today .bm-card__list,
.bm-card--now   .bm-card__list {
  @include scroll-pane;
  padding-inline-end: 0.25rem;
}

/* Stable scrollbars where supported */
@supports (scrollbar-gutter: stable) {
  .bm-card--today .bm-card__list,
  .bm-card--now   .bm-card__list,
  .bm-card--recent #recent-topics {
    scrollbar-gutter: stable;
  }
}

/* Nice thin scrollbars (shared) */
.bm-card--today .bm-card__list,
.bm-card--now  .bm-card__list,
.bm-card--recent #recent-topics {
  scrollbar-width: thin;
  scrollbar-color: rgba(0, 0, 0, 0.35) transparent;

  &::-webkit-scrollbar      { width: 10px; height: 10px; }
  &::-webkit-scrollbar-thumb{
    background: linear-gradient(180deg, rgba(0,0,0,0.35), rgba(0,0,0,0.2));
    border: 2px solid transparent;
    background-clip: padding-box;
    border-radius: 8px;
  }
  &::-webkit-scrollbar-track{ background: transparent; }
}

/* Focus visibility inside scrollers */
.bm-card--today  .bm-card__list :focus,
.bm-card--now    .bm-card__list :focus,
.bm-card--recent #recent-topics :focus {
  outline: 2px solid currentColor;
  outline-offset: 2px;
}

/* Short viewports: allow a bit taller panes */
@media (max-height: 720px) {
  :root { --stats-pane-h: clamp(220px, 50vh, 420px); }
}

/* Respect reduced motion */
@media (prefers-reduced-motion: reduce) {
  .rt-title { transition: none; }
  .rt-title::after { transition: none; }
}

/* ---------------- Utilities ---------------- */
.thin { font-size: 0.95em; opacity: 0.95; }

.bm-card--recent #recent-topics {
  align-items: stretch;
}
.bm-card--recent #recent-topics tr {
  display: grid;
  grid-template-rows: auto 1fr auto; /* title / flexible / date */
}