@import '../global/mixins.scss';

/* =========================================================
   BONE MARKET — POST ROW (GRID) + SLIDER (CONSOLIDATED)
   Layout: header | mini(sticky) + content + foot
   ========================================================= */

/* ---- Card shell ---- */
.bm-post{
  background: var(--bg-2);
  border-radius: 10px;
  margin-block: 1.25rem;
  position: relative;
  overflow: visible;
  padding: 0.75rem;
  min-block-size: 0; /* allow inner grid to shrink */

  /* dashed inset + corner ticks */
  &::before{
    content:"";
    position:absolute;
    inset:.6rem;
    border: var(--bdash);           /* ensure visible */
    opacity:.35;
    border-radius:8px;
    pointer-events:none;
  }
  @include corner-ticks(.6rem, 18px, 2px, .25);
}

/* ---- Grid layout (2 / 1+3+4) ---- */
.bm-post--grid{
  display:grid;
  grid-template-columns: clamp(240px, 26vw, 340px) 1fr;
  grid-template-rows: auto 1fr auto;
  align-items: stretch;
  grid-template-areas:
    "head head"
    "mini content"
    "mini foot";

  @media (max-width: 900px){
    grid-template-columns: 1fr;
    grid-template-rows: auto auto auto auto;
    grid-template-areas:
      "head"
      "mini"
      "content"
      "foot";
  }
}

/* =========================================================
   (2) HEADER
   ========================================================= */
.bm-post__head{
  grid-area: head;
  background: var(--bg-4);
  padding: .8rem 1rem;
  display:flex; align-items:baseline; justify-content:space-between; gap:.75rem;
  box-shadow: var(--plate-shadow);
  position: relative; isolation:isolate;

  &::after{
    content:"";
    position:absolute; inset-inline:1rem; inset-block-end:.45rem;
    height:2px;
    background:linear-gradient(90deg,
      color-mix(in srgb, var(--accent-1) 0%, transparent) 0%,
      color-mix(in srgb, var(--accent-1) 70%, transparent) 50%,
      color-mix(in srgb, var(--accent-1) 0%, transparent) 100%);
    opacity:.35; pointer-events:none;
  }

  .bm-post__title{ margin:0; font-family:var(--font-serif); font-size:1rem; }
  .bm-post__title a{ color:var(--text-clear); text-decoration:none; text-underline-offset:2px; }
  .bm-post__meta{ display:flex; align-items:center; gap:.5rem; flex-wrap:wrap; font-family: var(--font-sans); padding-right: 1rem; }
  .bm-post__meta .permalink{ opacity:.8; text-transform:lowercase; }
  .bm-post__meta .sep{ opacity:.6; }
}

/* =========================================================
   (1) MINI PROFILE = PURE-CSS SLIDER (STICKY)
   ========================================================= */
.ps-slider{
  grid-area: mini;
  --ps-w: 100%;
  --ps-h: 100%;
  inline-size: var(--ps-w);
  margin:0;
  display:flex; flex-direction: column;
  scroll-behavior: auto;

  position: sticky;
  top: calc(var(--nav-h, 64px) + .75rem);  /* fallback added */
  align-self: start;
  height: auto;
  z-index:1;

  @media (max-width: 900px){
    position: static; top:auto;            /* disable sticky on mobile */
    --ps-h: clamp(280px, 60vw, 460px);
  }
}

/* hide radios safely */
.ps-slider > input[type="radio"]{
  position:fixed; left:-9999px; top:-9999px;
  width:1px; height:1px; opacity:0; pointer-events:none;
}

/* viewport / track */
.ps-viewport {
  flex: 1;
  position:relative;
  block-size: var(--ps-h);
  overflow: hidden;
  border-bottom-left-radius:14px;
  box-shadow: var(--plate-shadow);
  isolation:isolate;
  height: 100%;
  min-height: 320px;

  /* “track” background */
  background: linear-gradient(to right, var(--bg-2) 0%, var(--bg-4) 100%);

  /* dashed inset + ticks */
  &::before{
    content:"";
    position:absolute; inset:.55rem;
    border: var(--bdash);
    border-radius:6px;
    opacity:.35; pointer-events:none; z-index:1;
  }
  @include corner-ticks(.55rem, 16px, 2px, .25);

  /* overlay under plates */
  &::after{
    content:"";
    position:absolute; inset:0;
    background: linear-gradient(180deg, rgba(0,0,0,.10), rgba(0,0,0,.50));
    z-index:0;
  }
}

/* background image layer (scrolls with content; no distortion) */
.ps-image{
  position: static;     /* moves naturally; keeps sticky behavior correct */
  z-index:-1;
  width:100%; height:auto; min-height:100%;
  display:block; object-fit:cover;
  object-position: center top;
  filter: brightness(.82) saturate(.9);
}

/* plates (slide text) */
.ps-plate{
  position:absolute; inset:0;
  display:grid; place-content:end center;
  padding:1.25rem 1.5rem 1.75rem;
  color:var(--text-clear); text-align:center;
  opacity:0; transform:translateY(12px);
  transition: opacity .35s ease, transform .35s ease;
  z-index:2;
}

.ps-plate--blank { pointer-events:none; opacity:0; }

.ps-title{
  font: 800 1.25rem/1.2 var(--font-serif, ui-serif);
  margin:0 0 .4rem;
  text-transform:lowercase;
  text-shadow:0 1px 0 rgba(0,0,0,.45);
}

.ps-body{ font: 500 .95rem/1.55 var(--font-sans, system-ui); opacity:.92; }

/* active plates */

/* arrows + dots */
.ps-arrows{ 
  position: absolute;
  /* keep them inside the dashed frame and above the dots */
  /* top/right/left equal to the dashed inset (.55rem), bottom leaves room for dots */
  inset: .55rem .55rem calc(.55rem + var(--ps-dots-h, 28px)) .55rem;

  display: grid;
  grid-template-columns: 1fr auto 1fr;  /* prev | spacer | next */
  align-items: center;                   /* <-- vertical centering */
  z-index: 2;
  pointer-events: none;
}

.ps-arrow {
  position: relative;          /* no absolute positioning needed */
  inline-size: 42px; 
  block-size: 42px;
  display: none;               /* hidden by default; shown based on slide */
  place-items: center;
  border-radius: 8px;
  line-height: 1;
  font-size: 1.25rem;

  background: color-mix(in srgb, var(--bg-4, #000) 65%, transparent);
  color: #fff;
  cursor: pointer;
  user-select: none;
  border: var(--bdash) var(--border-color);
  box-shadow: 0 8px 18px rgba(0,0,0,.35);
  transition: background .2s ease, transform .2s ease;

  pointer-events: auto;        /* re-enable clicks on the buttons themselves */

  &::after {
    content:"";
    position:absolute; inset:-8px;
  }
}
.ps-arrow:hover{ background: color-mix(in srgb, var(--bg-4, #000) 85%, transparent); transform: scale(1.05); }
.ps-arrow.prev{ grid-column:1; justify-self: start; right: 1.28rem; }
.ps-arrow.next{ grid-column: 3; justify-self: end; left: 1.28rem; }

.ps-dots{
  position:absolute; inset-inline:0; inset-block-end:.7rem;
  display:flex; justify-content:center; gap:.5rem; z-index:2;
}
.ps-dot{
  --ps-dots-h: 28px;
  inline-size:10px; block-size:10px; border-radius:999px;
  background: rgba(255,255,255,.45);
  border:1px solid rgba(255,255,255,.15);
  cursor:pointer; transition: transform .2s ease, background .2s ease;
}
.ps-dot:hover{ transform: scale(1.15); background: rgba(255,255,255,.75); }

/* position context + layering so arrows sit above the viewport */
.ps-slider{ position: sticky; z-index: 1; }
.ps-viewport{ position: relative; z-index: 0; }
.ps-arrows{ position: absolute; z-index: 2; }  /* above viewport */

/* --- Slider active states (PID-agnostic) --- */
.ps-slider input[id^="ps-0-"]:checked ~ .ps-viewport .ps-plate[data-i="0"],
.ps-slider input[id^="ps-1-"]:checked ~ .ps-viewport .ps-plate[data-i="1"],
.ps-slider input[id^="ps-2-"]:checked ~ .ps-viewport .ps-plate[data-i="2"],
.ps-slider input[id^="ps-3-"]:checked ~ .ps-viewport .ps-plate[data-i="3"]{
  opacity: 1;
  transform: translateY(0);
  pointer-events: auto;
}

/* Active dot highlight (include 0 if you want the blank to light up) */
.ps-slider input[id^="ps-0-"]:checked ~ .ps-viewport .ps-dot[for^="ps-0-"],
.ps-slider input[id^="ps-1-"]:checked ~ .ps-viewport .ps-dot[for^="ps-1-"],
.ps-slider input[id^="ps-2-"]:checked ~ .ps-viewport .ps-dot[for^="ps-2-"],
.ps-slider input[id^="ps-3-"]:checked ~ .ps-viewport .ps-dot[for^="ps-3-"]{
  background: var(--text-clear);
}

/* default: hide all arrows */
.ps-slider .ps-arrows .ps-arrow { display: none; }

/* show exactly one pair for the active slide */
.ps-slider:has(> input[id^="ps-0-"]:checked) .ps-arrows .ps-arrow.for-0,
.ps-slider:has(> input[id^="ps-1-"]:checked) .ps-arrows .ps-arrow.for-1,
.ps-slider:has(> input[id^="ps-2-"]:checked) .ps-arrows .ps-arrow.for-2,
.ps-slider:has(> input[id^="ps-3-"]:checked) .ps-arrows .ps-arrow.for-3 {
  display: grid;
}

.ps-plate{ pointer-events:none; z-index: 1; }
.ps-plate a, .ps-plate button, .ps-plate [tabindex] { pointer-events:auto; }
.ps-arrows{ z-index: 3; pointer-events:none; }
.ps-arrow{  pointer-events:auto; }


@media (prefers-reduced-motion: reduce){
  .ps-plate, .ps-arrow{ transition:none; }
}

/* =========================================================
   (3) CONTENT
   ========================================================= */
.bm-post__content{
  grid-area: content;
  background: var(--bg-2);
  box-shadow: var(--plate-shadow);
  padding: 1rem;
  min-height: 220px;
  margin: 1rem auto;

  /* fill the column */
  justify-self: stretch; align-self: stretch;
  width: 40vw; min-width: 0;

  /* content baseline (scoped) */
  --flow:.85rem;
  font-size: var(--size-md);
  line-height: 1.65; color: var(--text-clear);
  text-align: justify;

  > * + * { margin-block-start: var(--flow); }

  a{ color: inherit; text-decoration: underline; text-decoration-thickness:.08em; text-underline-offset:.2em; transition: opacity .15s ease; &:hover{ opacity:.85; } }
  strong,b{ font-weight:700; color: var(--text-hiCon, currentColor); }
  em,i{ font-style: italic; }
  small{ font-size:.86em; opacity:.9; }
  mark{ background: rgba(255,229,100,.5); padding:0 .2em; border-radius:.15rem; }

  h1,h2,h3,h4,h5,h6{ font-family: var(--font-serif); line-height:1.25; color: var(--text-clear); text-wrap: balance; }
  h1{ font-size: clamp(1.4rem, calc(1.2vw + 1rem), 1.9rem); }
  h2{ font-size: clamp(1.25rem, calc(1vw + .9rem), 1.6rem); }
  h3{ font-size: clamp(1.12rem, calc(.6vw + .9rem), 1.35rem); }
  h4,h5,h6{ font-size: 1rem; letter-spacing:.02em; }

  hr{ border:0; height:1px; background: linear-gradient(90deg, transparent, rgba(0,0,0,.25), transparent); margin-block: calc(var(--flow) + .25rem); }

  ul,ol{ padding-inline-start: 1.25rem; }
  li{ margin-block:.35rem; }
  ul ::marker{ color: var(--text-loCon); }

  blockquote{
    background: var(--bg-2);
    border: 1px solid rgba(0,0,0,.18);
    border-left: 6px solid var(--text-loCon);
    border-radius: 4px;
    padding: .9rem 1rem .95rem;
    margin-inline: 0;
  }
  blockquote blockquote{ border-left-color: var(--accent-2, #8e7c63); }

  code,kbd,pre{ font-family: var(--font-mono, ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace); font-size:.94em; }
  code,kbd{ background: var(--bg-2); border: 1px solid rgba(0,0,0,.18); border-radius: 4px; padding:.1rem .35rem; }
  pre{ background: var(--bg-2); border:1px solid rgba(0,0,0,.18); border-radius:6px; padding:.85rem 1rem; overflow:auto; }
  pre code{ border:0; background:transparent; padding:0; }

  .quotetop,.codetop{ font-family:var(--font-serif); font-variant: small-caps; letter-spacing:.04em; opacity:.8; background: var(--bg-3); border:1px solid rgba(0,0,0,.2); border-bottom:0; padding:.4rem .6rem; border-radius:4px 4px 0 0; }
  .quotemain,.codemain{ background: var(--bg-2); border:1px solid rgba(0,0,0,.2); border-radius:0 0 4px 4px; padding:.8rem 1rem; }

  img{ max-width:100%; height:auto; display:block; }
  .alignleft  { float:left;  margin:.2rem 1rem .8rem 0;  max-width: clamp(0px, 45%, 320px); }
  .alignright { float:right; margin:.2rem 0 .8rem 1rem;  max-width: clamp(0px, 45%, 320px); }
  .aligncenter{ margin-inline:auto; display:block; }

  figure{ margin:0; border: var(--border-1); border-radius:6px; overflow:hidden; box-shadow: var(--plate-shadow); background: var(--bg-1-rgb); }
  figcaption{ font-size:.9em; opacity:.9; padding:.5rem .75rem; border-top: var(--border-1); }

  .table-scroll{ overflow:auto; border: var(--border-1); border-radius:6px; }
  table{ width:100%; border-collapse: collapse; background: var(--bg-1-rgb); font-size:.95em; }
  th,td{ border:1px solid rgba(0,0,0,.2); padding:.5rem .6rem; }
  th{ background: var(--bg-3); text-align:left; }

  .spoiler,.hideme{ border: var(--border-1); border-radius:6px; background: var(--bg-2); overflow:hidden; }
  .spoiler > .title, .hideme > .title{ display:block; padding:.55rem .7rem; background: var(--bg-3); cursor:pointer; user-select:none; }
  .spoiler > .content, .hideme > .content{ padding:.75rem .9rem; }

  .mention, a[data-mention]{ background: rgba(142,124,99,.2); border-radius:.25rem; padding-inline:.25rem; text-decoration:none; }

  .post-tag, .label, .badge{ /* in-content badges; general look defined elsewhere */ }

  .postcolor{
    max-width: 100%;
    margin: 0;
    text-align: justify;
    white-space: pre-line;
    font-family: var(--font-serif);
    font-size: var(--size-lg);
  }
}
.bm-post__content ::selection{ background: rgba(196,67,88,.25); }

/* =========================================================
   (4) FOOTER
   ========================================================= */
.bm-post__foot--mini{
  grid-area: foot;
  background: var(--bg-4);
  box-shadow: var(--plate-shadow);
  padding: .65rem .9rem;
  display:flex; align-items:center; gap:.5rem; flex-wrap:wrap;
}

/* =========================================================
   BADGES / REACTIONS / MENTIONS
   ========================================================= */
a[href*="showuser"][data-mention]{
  background: color-mix(in srgb, var(--accent-2, #8e7c63) 20%, transparent);
  border-radius:.25rem; padding-inline:.25rem;
}

.bm-post .badge, .bm-post .label, .bm-post .chip{
  --pill-bg: var(--bg-1-rgb);
  display:inline-flex; align-items:center; gap:.35ch;
  padding:.15rem .55rem; border:1px solid currentColor; border-radius:999px;
  line-height:1.1; font-size:.8rem;
  background: linear-gradient(180deg, rgba(255,255,255,.08), rgba(0,0,0,.08)), var(--pill-bg);
  box-shadow: inset 0 0 0 1px rgba(255,255,255,.06);
}
.bm-post[data-group="crown"]  .badge{ background: linear-gradient(90deg, rgba(204,67,88,.22), rgba(204,67,88,.05)); color: rgb(204,67,88); }
.bm-post[data-group="core"]   .badge{ background: linear-gradient(90deg, rgba(142,124,99,.22), rgba(142,124,99,.05)); color: rgb(142,124,99); }
.bm-post[data-group="hollow"] .badge{ background: linear-gradient(90deg, rgba(106,77,73,.22), rgba(106,77,73,.05)); color: rgb(106,77,73); }

.bm-post__reactions{
  display:flex; flex-wrap:wrap; gap:.35rem .5rem;
  .chip{ font-size:.78rem; background: var(--bg-1-rgb); border: var(--border-1); &:hover{ transform: translateY(-1px); } }
}

/* =========================================================
   PAGINATION + ACTION BUTTONS (topic bars)
   ========================================================= */
.pagination{
  font-size:.75rem; display:inline-flex; align-items:baseline; gap:.25rem;
  vertical-align:middle; font-family: var(--font-hand);
}
.pagination_pagetxt{ font-variant: small-caps; letter-spacing:.04em; opacity:.85; margin-right:.5rem; }
.pagination_page, .pagination_last, .pagination_current{
  all:unset; display:inline; cursor:pointer; color: var(--text-clear);
}
.pagination_page, .pagination_last{ text-decoration:none; }
.pagination_page:hover, .pagination_last:hover{ text-decoration:underline; }
.pagination_current b{ font-weight:700; border-bottom:2px solid currentColor; padding-bottom:.05em; }
.pagination_last{ white-space:nowrap; }

/* keyboard focus */
:where(.pagination a, .pagination_current, .macro--button):focus-visible{
  outline:2px dashed currentColor; outline-offset:2px;
}

/* First unread as chip */
.pagination_last{ font-size:0; }
.pagination_last a{
  font-size:.75rem; text-decoration:none;
  @include plate-button($font-size: var(--size-md));
  border-radius:6px; padding:.45rem .9rem;
}

/* Topic action buttons */
:where(.postlinksbar, .topic-options, .topic-buttons, .pagelinks, .tableborder) a[href*="act=Post"],
.postlinksbar a[href^="javascript:ShowHide"],
.topic-options a[href^="javascript:ShowHide"],
.topic-buttons a[href^="javascript:ShowHide"],
.pagelinks a[href^="javascript:ShowHide"],
.tableborder a[href^="javascript:ShowHide"],
a[href^="javascript:$('#topic_open')"],
a[title="Open Topic Options"],
a[title="Open Fast Reply Window"]{
  @include plate-button($font-size: var(--size-md));
  border-radius:6px; padding:.5rem 1rem; text-decoration:none; font-weight:600; line-height:1.1;
}

/* neutralize default macro look in the bars */
.postlinksbar .macro--button,
.topic-options .macro--button,
.topic-buttons .macro--button,
.pagelinks .macro--button{ border:0; background:none; box-shadow:none; padding:0; }

/* spacing next to pagination */
.pagelinks a[href*="act=Post"]{ margin-inline-start:.35rem; }

/* hide specific actions */
a[href*="act=Post"][href*="CODE=10"],
a[href*="act=Post"][href*="CODE=14"]{ display:none; }

/* =========================================================
   TABLES + MISC SHELL UI
   ========================================================= */
.tableborder .maintitle{
  --gh-thickness: 2px; --gh-alpha:.35; --gh-gap-x:1rem; --gh-gap-y:.25rem; --gh-pad-b:.5rem; --gh-max-desc:52ch;
  --gh-grad: linear-gradient(90deg,
    color-mix(in srgb, var(--accent-1) 0%,  transparent) 0%,
    color-mix(in srgb, var(--accent-1) 70%, transparent) 50%,
    color-mix(in srgb, var(--accent-1) 0%,  transparent) 100%);

  background: var(--bg-2);
  border-radius:8px 8px 0 0;
  box-shadow: var(--plate-shadow);
  position: relative; display:grid; grid-template-columns: auto minmax(0,1fr);
  align-items:end; column-gap: var(--gh-gap-x); row-gap: var(--gh-gap-y);
  padding:.85rem 1rem calc(.9rem + var(--gh-thickness));
  color: var(--text-clear); isolation:isolate;

  &::after{
    content:""; position:absolute;
    inset-inline:1rem; inset-block-end:.45rem;
    height: var(--gh-thickness); background: var(--gh-grad); opacity: var(--gh-alpha);
    pointer-events:none;
  }

  .topic-title-space{ display:none; }
  .topic-title{
    min-width:0; margin:0; font-family:var(--font-serif); font-weight:800;
    font-size:4vw; line-height:1.05; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
    font-variant: all-petite-caps;
  }
  .topic-desc{
    min-width:0; justify-self:end; text-align:end;
    font: 600 1rem/1.2 var(--font-serif);
    color: var(--text-medCon);
    max-inline-size: var(--gh-max-desc);
    white-space:nowrap; overflow:hidden; text-overflow:ellipsis; text-transform:lowercase;
  }
}
@media (max-width: 900px){
  .tableborder .maintitle{
    grid-template-columns: 1fr; row-gap:.35rem;
    .topic-desc{
      justify-self:start; text-align:start;
      white-space:normal; overflow:visible; text-overflow:clip;
    }
  }
}

/* “plate” table look when it contains pagination */
table:has(.pagination){
  background: var(--bg-2);
  border-radius: 8px;
  box-shadow: var(--plate-shadow);
  border-collapse: separate; border-spacing:0; overflow: clip;
}
table:has(.pagination) td{ padding:.5rem .75rem; }

.postlinksbar{
  background: var(--bg-2);
  padding-right:.5rem;
  & strong, b{ color: var(--link); font-family: var(--font-sans); font-size: var(--size-sm); font-variant: all-small-caps; }
}

/* =========================================================
   FORMS
   ========================================================= */
input, select, textarea, option{
  background: var(--bg-2);
  color: var(--text-medCon);
  font-family: var(--font-sans);
  letter-spacing:.05rem;
  height:1.75rem;
  font-size: var(--size-md);
  border:none;
}
input[type="submit"]{
  color: var(--accent-2);
  font-weight:800;
  letter-spacing:.1rem;
  background: var(--bg-4);
}

/* =========================================================
   MISC
   ========================================================= */
.bm-post:target{
  outline: 1px dashed currentColor; outline-offset:4px;
  scroll-margin-top: calc(var(--nav-h, 64px) + 1rem);
}
.activeuserstrip, .row2{
  text-align:center; font-family: var(--font-sans); font-size: var(--size-sm); text-transform: uppercase;
  strong{ font-weight:800; }
}


